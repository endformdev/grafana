name: End-to-end tests

on:
  pull_request:
  push:
    branches:
      - main
      - release-*.*.*

# TODO: re-enable this before merging
# concurrency:
#   group: ${{ github.workflow }}-${{ github.ref }}
#   cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

permissions: {}

env:
  ACTIONS_STEP_DEBUG: true
  RUNNER_DEBUG: 1

jobs:
  build-grafana:
    name: Build & Package Grafana
    runs-on: blacksmith-8vcpu-ubuntu-2404
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      # TODO: add a cleanup workflow to remove the cache when the PR is closed
      # https://github.com/actions/cache/blob/main/tips-and-workarounds.md#force-deletion-of-caches-overriding-default-cache-eviction-policy
      # TODO: maybe we could just use the cache to store the build, instead of uploading as an artifact?
      - uses: actions/cache@v4
        id: cache
        with:
          key: "build-grafana-${{ runner.os }}-${{ hashFiles('yarn.lock', 'public/*',  'packages/*', 'conf/*', 'pkg/**/*.go', '**/go.mod', '**/go.sum', '!**_test.go', '!**.test.ts', '!**.test.tsx', 'Dockerfile') }}"
          path: |
            build-dir

      # If no cache hit, build Grafana
      - name: Build Grafana
        if: steps.cache.outputs.cache-hit != 'true'
        uses: dagger/dagger-for-github@d913e70051faf3b907d4dd96ef1161083c88c644
        with:
          version: 0.18.8
          verb: run
          args: go run ./pkg/build/cmd artifacts -a targz:grafana:linux/amd64 -a docker:grafana:linux/amd64 --grafana-dir="${PWD}" > out.txt
      - name: Cat built artifact
        if: steps.cache.outputs.cache-hit != 'true'
        run: cat out.txt
      - name: Move built artifacts
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p build-dir
          mv "$(grep 'grafana_.*tar.gz$' out.txt | grep -Fv -m1 'docker')" build-dir/grafana.tar.gz
          mv "$(grep 'grafana_.*docker.tar.gz$' out.txt)" build-dir/grafana.docker.tar.gz

      # If cache hit, validate the artifact is present
      - name: Validate artifact
        if: steps.cache.outputs.cache-hit == 'true'
        run: |
          if [ ! -f build-dir/grafana.tar.gz ]; then
            echo "Error: build-dir/grafana.tar.gz not found in cache"
            exit 1
          fi

      - name: Set artifact name
        run: echo "artifact=grafana-server-${{github.run_number}}" >> "$GITHUB_OUTPUT"
        id: artifact

      - name: Upload grafana.tar.gz
        uses: actions/upload-artifact@v5
        with:
          retention-days: 1
          name: grafana-tar-gz
          path: build-dir/grafana.tar.gz

      - name: Upload grafana docker tarball
        uses: actions/upload-artifact@v5
        with:
          retention-days: 1
          name: grafana-docker-tar-gz
          path: build-dir/grafana.docker.tar.gz

  run-playwright-tests:
    needs:
      - build-grafana
    name: Playwright E2E tests (${{ matrix.shard }}/${{ matrix.shardTotal }})
    runs-on: blacksmith-8vcpu-ubuntu-2404
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        shard: [1]
        shardTotal: [8]

    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - uses: actions/download-artifact@v6
        with:
          name: grafana-tar-gz

      - name: Run E2E tests
        uses: dagger/dagger-for-github@d913e70051faf3b907d4dd96ef1161083c88c644
        with:
          version: 0.18.8
          verb: run
          args: go run ./pkg/build/e2e-playwright --package=grafana.tar.gz --shard=${{ matrix.shard }}/${{ matrix.shardTotal }} --blob-dir=./blob-report
        env:
          ENDFORM_API_KEY: ${{ secrets.ENDFORM_API_KEY }}
